language: node_js

node_js:
  - "lts/*"
  - "stable"

cache: npm

before_install:
  - git config --global user.email "$CI_USER_EMAIL"
  - git config --global user.name "$CI_USER_NAME"
  - echo -e "machine github.com\n  login $CI_USER_TOKEN" > ~/.netrc
  - git clone "https://$CI_USER_NAME:$CI_USER_TOKEN@github.com/$TRAVIS_REPO_SLUG.git" $TRAVIS_REPO_SLUG
  - cd $TRAVIS_REPO_SLUG
  - git checkout -qf $TRAVIS_BRANCH --
  - npm i -g makeshift && makeshift -r registry.npmjs.org

script:
  - npm run test

before_deploy:
  - chmod +x scripts/semver.sh
  - chmod +x scripts/bump-version.sh
  - chmod +x scripts/version-deprecator.sh
  - git update-index --assume-unchanged scripts/bump-version.sh
  - git update-index --assume-unchanged scripts/semver.sh
  - git update-index --assume-unchanged scripts/version-deprecator.sh

# Deployment stage that only runs on a stable version of node
jobs:
  include:
    - stage: deploy
      name: "Publish a new distribution to NPM"
      node_js: "stable"
      if: fork = false AND type = push # Publish only on push events on branches in the org
      deploy:
        - provider: script
          script: scripts/bump-version.sh $TRAVIS_BRANCH
          skip_cleanup: true
          on:
            all_branches: true
            repo: romcal/romcal
        - provider: script
          script: scripts/version-deprecator.sh $TRAVIS_BRANCH
          skip_cleanup: true
          on:
            all_branches: true
            repo: romcal/romcal

after_deploy:
  - git update-index --no-assume-unchanged scripts/bump-version.sh
  - git update-index --no-assume-unchanged scripts/semver.sh
  - git update-index --no-assume-unchanged scripts/version-deprecator.sh

notifications:
  email:
    recipients:
      - $CI_USER_EMAIL
    on_success: change
    on_failure: always
